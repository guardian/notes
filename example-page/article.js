define("common/utils/ajax-promise",["common/utils/ajax","Promise"],function(e,t){return function(o){var n=new t(function(t,n){e(o).then(function(e){t(e)}).fail(function(e,t,o){var i=o?o:new Error(t);i.request=e,n(i)})});return n}}),define("text!common/views/content/richLinkTag.html",[],function(){return'<aside class="element element-rich-link element-rich-link--tag element--thumbnail element-rich-link--not-upgraded" data-component="rich-link-tag" data-link-name="rich-link-tag">\n    <p><a href="<%=href%>"><%=href%></a></p>\n</aside>\n'}),define("common/modules/article/rich-links",["fastdom","qwery","Promise","common/utils/_","common/utils/$","common/utils/ajax-promise","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/template","common/modules/article/spacefinder","common/modules/ui/images","text!common/views/content/richLinkTag.html"],function(e,t,o,n,i,s,r,a,c,m,l,u,d){function p(t){var n=i("a",t).attr("href"),r=n.match(/(?:^https?:\/\/(?:www\.|m\.code\.dev-)theguardian\.com)?(\/.*)/);return r&&r[1]?s({url:"/embed/card"+r[1]+".json",crossOrigin:!0}).then(function(o){o.html&&e.write(function(){i(t).html(o.html).removeClass("element-rich-link--not-upgraded").addClass("element-rich-link--upgraded"),u.upgradePictures(t),i(".submeta-container--break").removeClass("submeta-container--break"),c.emit("rich-link:loaded",t)})}):o.resolve(null)}function h(){return{minAbove:200,minBelow:250,clearContentMeta:50,selectors:{" > h2":{minAbove:"mobile"===a.getBreakpoint()?20:0,minBelow:200}," > *:not(p):not(h2):not(blockquote)":{minAbove:35,minBelow:300}," .ad-slot":{minAbove:150,minBelow:200}," .element-rich-link":{minAbove:500,minBelow:500}}}}function f(){var t=i(".element-rich-link a").map(function(e){return i(e).attr("href")}),s=function(e){return n.contains(r.page.richLink,e)},a=t.some(s),c=r.page.shouldHideAdverts||!r.page.showRelatedContent;return!r.page.richLink||-1!==r.page.richLink.indexOf(r.page.pageId)||c||a?o.resolve(null):l.getParaWithSpace(h()).then(function(t){return new o(function(o){t?e.write(function(){var e=i.create(m(d,{href:r.page.richLink}));e.insertBefore(t),o(p(e[0]))}):o(null)})})}function g(){i(".element-rich-link--not-upgraded").each(p)}return{upgradeRichLink:p,upgradeRichLinks:g,insertTagRichLink:f,getSpacefinderRules:h}}),define("common/modules/article/membership-events",["fastdom","common/utils/$","common/utils/ajax-promise"],function(e,t,o){function n(n){var i=t("a",n).attr("href"),a=i.match(/https:\/\/membership.theguardian.com/);a&&o({url:i+"/card",crossOrigin:!0}).then(function(o){o.html&&e.write(function(){t(n).html(o.html).removeClass(s).addClass(r)})})}function i(){t("."+s).each(n)}var s="element-membership--not-upgraded",r="element-membership--upgraded";return{upgradeEvent:n,upgradeEvents:i}}),define("common/modules/article/open-module",["fastdom","common/utils/$","common/utils/ajax","common/utils/config","common/utils/detect","common/modules/article/spacefinder"],function(e,t,o,n,i,s){function r(){return{minAbove:200,minBelow:250,clearContentMeta:50,selectors:{" > h2":{minAbove:"mobile"===i.getBreakpoint()?20:0,minBelow:200}," > *:not(p):not(h2)":{minAbove:35,minBelow:300}," .ad-slot":{minAbove:150,minBelow:200}," .element-rich-link":{minAbove:400,minBelow:400}}}}return{init:function(){n.page.openModule&&s.getParaWithSpace(r()).then(function(i){i&&o({url:n.page.openModule,crossOrigin:!0,method:"get"}).then(function(o){o.html&&e.write(function(){t.create(o.html).addClass("element--supporting").insertBefore(i),t(".submeta-container--break").removeClass("submeta-container--break")})})})}}}),define("common/modules/article/truncation",["bean","bonzo","fastdom","common/utils/$"],function(e,t,o,n){return function(){o.write(function(){var i=t.create('<button class="button button--large button--primary button--show-more content__read-more-button" data-link-name="more"><i class="i i-plus-white"></i> Read more</button>')[0],s=n(".js-article__body"),r="content__article-body--truncated";e.on(i,"click",function(){o.write(function(){s.removeClass(r)})}),s.addClass(r).append('<div class="content__truncation-overlay"></div>').append(i)})}}),define("common/modules/onward/social-most-popular",["common/modules/component","common/utils/mediator"],function(e,t){function o(e,t){this.context=e,this.endpoint="/most-read-"+t+".json",this.fetch(this.context,"html")}return e.define(o),o.prototype.ready=function(e){t.emit("page:new-content",e)},o}),define("fence",[],function(){function e(t,o,n,i){i=i||0,t(),o>0&&setTimeout(function(){var s=n+i;e(t,o-1,s,n)},n)}function t(t){setTimeout(function(){e(function(){r(t),a(t)},h,p)},0)}function o(e,t){return e.classList?e.classList.contains(t):-1!==e.className.indexOf(t)}function n(e,t){return e.classList?e.classList.add(t):e.className+=" "+t}function i(){for(var e="iframe."+u,t=document.querySelectorAll(e),o=0,n=t.length;n>o;++o)s(t[o])}function s(e,i){if(i=i||{},"IFRAME"!==e.tagName)throw new Error("Cannot render non-iframe elements!");if(!o(e,u))throw new Error("Cannot render iframes with no "+u+" class!");var s=o(e,d);if(!s||i.force){e.style.height=0,e.frameBorder=0,e.style.border="none",e.style.overflow="hidden",e.width="100%";var r=!!e.srcdoc;if(r)"complete"===e.contentWindow.document.readyState?t(e):s||e.addEventListener("load",function(){t(e)},!1);else{var a=e.getAttribute("srcdoc");a&&"string"==typeof a&&(e.contentWindow.contents=a,e.src='javascript:window["contents"]',t(e))}n(e,d)}}function r(e){var t=e.contentWindow&&e.contentWindow.document,o=t&&t.body;o&&(o.style.padding=0,o.style.margin=0,o.style.overflow="hidden")}function a(e){var t=e.contentWindow&&e.contentWindow.document;if(t){var o=t.documentElement&&t.documentElement.scrollHeight||t.body&&t.body.scrollHeight||0;e.style.height=o+"px"}}function c(e){var t=document.createElement("div");t.innerHTML=(e||"").trim();var o=t.firstChild,n=o&&"IFRAME"===o.tagName,i=o&&!o.nextSibling;return n&&i}function m(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}function l(e){if(c(e))return e;var t=m(e).replace(/\"/g,"&quot;"),o="<html><head></head><body>"+t+"</body></html>";return'<iframe srcdoc="'+o+'" class="'+u+'"></iframe>'}var u="fenced",d="fenced-rendered",p=300,h=12;return{render:s,renderAll:i,isSafeCode:c,wrap:l}}),define("common/modules/article/twitter",["bean","bonzo","qwery","common/utils/_","common/utils/$","common/utils/config","common/utils/detect","common/utils/mediator"],function(e,t,o,n,i,s,r,a){function c(){a.on("window:scroll",n.debounce(m,200))}function m(){if("mobile"!==r.getBreakpoint()&&s.switches.enhanceTweets){var e,n=o("blockquote.js-tweet"),a=o("#twitter-widget"),c=t.viewport().height,m=o("blockquote.twitter-tweet");n.forEach(function(e){var o=t(e);t(document.body).scrollTop()+2.5*c>o.offset().top&&t(document.body).scrollTop()<o.offset().top+o.offset().height&&i(e).removeClass("js-tweet").addClass("twitter-tweet")}),m.length>0&&(0===a.length?(e=document.createElement("script"),e.id="twitter-widget",e.async=!0,e.src="//platform.twitter.com/widgets.js",i(document.body).append(e)):"undefined"!=typeof twttr&&"widgets"in twttr&&"load"in twttr.widgets&&twttr.widgets.load(l))}}var l=o(".js-liveblog-body");return{init:c,enhanceTweets:m}}),define("common/modules/article/truncate",["common/utils/$","bean","bonzo","qwery","common/utils/_","common/utils/config","common/utils/detect","common/utils/mediator","common/modules/article/twitter"],function(e,t,o,n,i,s,r,a,c){function m(){e(".truncated-block blockquote.tweet-truncated").removeClass("tweet-truncated").addClass("js-tweet"),g.removeClass(d),e(".article-elongator").addClass("u-h"),c.enhanceTweets()}function l(){var e=window.location.hash.slice(1);return i.find(f,function(t){return t.id===e})}function u(){var o=h.length,n=o-p,i="";s.page.isLiveBlog&&o>p&&!l()&&(i=1===n?"View 1 more update":"View "+n+" more updates",e.create('<button class="u-button-reset button button--large button--show-more liveblog__show-more article-elongator" data-link-name="continue reading" data-test-id="article-expand"><i class="i i-plus-white"></i>'+i+"</button>").each(function(t){e(".js-liveblog-body").append(t)}),t.on(document.body,"click",".article-elongator",m.bind(this)),a.on("module:liveblog:showkeyevents",m.bind(this)),a.on("module:filter:toggle",m.bind(this)),g.addClass(d),e(".truncated-block blockquote.tweet").removeClass("js-tweet").addClass("tweet-truncated"))}var d="truncated-block",p="mobile"===r.getBreakpoint()?5:10,h=n(".block"),f=h.slice(p),g=o(f);return u}),define("common/utils/clamp",["bonzo","bean"],function(e,t){var o=function(o,n,i){var s,r=o.clientHeight,a=getComputedStyle(o).getPropertyValue("line-height"),c=(parseInt(a,10)+(i?2:0))*n,m=e(e.create('<span class="clamp-fade"></span>')),l=e(o);c>r||(l.css({maxHeight:c+"px",overflow:"hidden"}),l.after(m),i&&(s=e(e.create('<span class="clamp-fade__content u-fauxlink" role="button">Read more</span>')),m.append(s),t.on(s[0],"click",function(){m.remove(),l.css({maxHeight:"none",overflow:"auto"})})))};return o}),define("common/modules/open/cta",["common/utils/$","common/utils/clamp","common/modules/component"],function(e,t,o){var n=function(e,t){this.mediator=e,this.setOptions(t)};return o.define(n),n.prototype.endpoint="/open/cta/article/:discussionKey.json",n.prototype.componentClass="comment",n.prototype.useBem=!0,n.prototype.defaultOptions={discussionKey:null},n.prototype.prerender=function(){var t=e(".comment",this.elem),o=t[Math.floor(Math.random()*t.length)+0];0===t.length?this.destroy():this.elem=o},n.prototype.ready=function(){t(this.getElem("body"),10,!0)},n}),define("common/modules/ui/last-modified",["bean","fastdom","qwery","common/utils/$"],function(e,t,o,n){return function(){var i=n(".js-lm");i&&(t.write(function(){n(".js-wpd").addClass("content__dateline-wpd--modified tone-colour")}),e.on(o(".js-wpd")[0],"click",function(){t.write(function(){i.toggleClass("u-h")})}))}}),define("common/utils/client-rects",[],function(){var e,t=function(){if(void 0===e){var t=document.createElement("p"),o=document.createElement("p"),n=document.createTextNode("aa"),i=document.createTextNode("aa"),s=document.createRange();t.appendChild(n),o.appendChild(i),document.body.appendChild(t),document.body.appendChild(o),s.setStart(n,1),s.setEnd(i,1),e=s.getClientRects().length>2,document.body.removeChild(t),document.body.removeChild(o)}return e},o=function(e){if(!t())return e.getClientRects();for(var o=[],n=e.endContainer,i=e.endOffset,s=document.createRange();n!==e.commonAncestorContainer;)s.setStart(n,0),s.setEnd(n,i),Array.prototype.push.apply(o,s.getClientRects()),i=Array.prototype.indexOf.call(n.parentNode.childNodes,n),n=n.parentNode;return s=e.cloneRange(),s.setEnd(n,i),Array.prototype.push.apply(o,s.getClientRects()),o},n=function(e){var n,i,s,r=o(e),a=e.getBoundingClientRect();if(0===r.length)return null;if(!t())return e.getBoundingClientRect();if(0===a.width&&0===a.height)return r[0];for(n=0,i=r.length;i>n;n++)s=s||{left:r[n].left,top:r[n].top,right:r[n].right,bottom:r[n].bottom},s.left=Math.min(s.left,r[n].left),s.top=Math.min(s.top,r[n].top),s.right=Math.max(s.right,r[n].right),s.bottom=Math.max(s.bottom,r[n].bottom);return s&&(s.width=s.right-s.left,s.height=s.bottom-s.top),s};return{getClientRects:o,getBoundingClientRect:n}}),define("text!common/views/ui/selection-sharing.html",[],function(){return'<div class="selection-sharing">\n    <ul class="social u-unstyled u-cf" data-component="social-selection">\n        <li class="social__item" data-link-name="twitter">\n            <a  class="rounded-icon social-icon social-icon--twitter js-selection-twitter"\n                data-link-name="social-selection"\n                target="_blank"\n                href="#">\n                <span class="u-h">Share on Twitter</span>\n                <i class="i-share-twitter--white i"></i>\n            </a>\n        </li>\n        <li class="social__item" data-link-name="email">\n            <a  class="rounded-icon social-icon social-icon--email js-selection-email"\n                data-link-name="social-selection"\n                target="_blank"\n                href="#">\n                <span class="u-h">Share via Email</span>\n                <i class="i-share-email--white i"></i>\n            </a>\n        </li>\n    </ul>\n</div>\n'}),define("common/modules/ui/selection-sharing",["bean","bonzo","common/utils/_","common/utils/$","common/utils/client-rects","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/template","text!common/views/ui/selection-sharing.html"],function(e,t,o,n,i,s,r,a,c,m){var l,u,d=t(document.body),p=n.create(m),h=s.page.shortUrl+"/stw",f='https://twitter.com/intent/tweet?text="<%=text%>"&url=<%=url%>',g=115,v=s.page.shortUrl+"/sbl",b='mailto:?subject=<%=subject%>&body="<%=selection%>" <%=url%>',y=["js-article__body","content__standfirst","block","caption--main","content__headline"],w=function(){var e,t,o,n,r,a,m=window.getSelection&&document.createRange&&window.getSelection();if(m&&m.rangeCount>0&&m.toString()){if(e=m.getRangeAt(0),t=i.getBoundingClientRect(e),o=d.scrollTop()+t.bottom,n=e.toString(),!x(e))return void C();n.length>g&&(n=n.slice(0,g-1)+"…"),r=c(f,{text:encodeURI(n),url:encodeURI(h)}),a=c(b,{subject:encodeURI(s.page.webTitle),selection:encodeURI(e.toString()),url:encodeURI(v)}),l.attr("href",r),u.attr("href",a),p.css({top:o+"px",left:t.left+"px"}),k()}else C()},C=function(){p.hasClass("selection-sharing--active")&&p.removeClass("selection-sharing--active")},k=function(){p.hasClass("selection-sharing--active")||p.addClass("selection-sharing--active")},T=function(e){n.ancestor(e.target,"social__item")||C()},_=function(){r.hasTouchScreen()||(d.append(p),l=n(".js-selection-twitter"),u=n(".js-selection-email"),e.on(document.body,"keypress keydown keyup",o.debounce(w,50)),e.on(document.body,"mouseup",o.debounce(w,200)),e.on(document.body,"mousedown",o.debounce(T,50)),a.on("window:resize",o.throttle(w,50)))},x=function(e){return o.some(y,function(t){return n.ancestor(e.startContainer,t)&&n.ancestor(e.endContainer,t)})};return{init:_,updateSelection:w}}),define("bootstraps/article-liveblog-common",["fence","common/utils/$","common/utils/config","common/utils/mediator","common/utils/robust","common/modules/article/truncate","common/modules/article/twitter","common/modules/open/cta","common/modules/ui/last-modified","common/modules/ui/rhc","common/modules/ui/selection-sharing"],function(e,t,o,n,i,s,r,a,c,m,l){function u(){if(o.switches.openCta&&o.page.commentable){var e=new a(n,{discussionKey:o.page.shortUrl.replace("http://gu.com/","")});t.create('<div class="open-cta"></div>').each(function(t){e.fetch(t),o.page.isLiveBlog||m.addComponent(t)})}}function d(){t(".fenced").each(function(t){e.render(t)})}function p(){s(),r.init(),r.enhanceTweets()}return function(){i("trail-article",u),i("trail-fence",d),i("trail-twitter",p),i("trail-sharing",l.init),i("trail-last-modified",c)}}),define("enhancer",[],function(){function e(e,t,o,n){var i=e.getAttribute("data-interactive");require([i],function(i){i.boot(e,t,o,n)})}return{render:e}}),define("common/utils/contains",[],function(){return function(e,t){for(var o=0;o<e.length;++o)if(e[o]===t)return!0;return!1}}),define("common/utils/proximity-loader",["bonzo","common/utils/_","common/utils/mediator"],function(e,t,o){function n(e,t){var n={conditionFn:e,loadFn:t};a.push(n),1===a.length&&o.on("window:scroll",s),r()}function i(t,o,i){var s=e(t),r=function(){var e=s.offset(),t=e.top-o,n=e.top+e.height+o;return c.top>t&&c.bottom<n};n(r,i)}var s,r,a=[],c={top:0,bottom:0},m=function(){c.top=e(document.body).scrollTop(),c.bottom=c.top+e.viewport().height,a=t.filter(a,function(e){return e.conditionFn()?void e.loadFn():!0}),0===a.length&&o.off("window:scroll",s)};return s=t.throttle(m,200,{leading:!1,trailing:!0}),r=t.debounce(m,2e3),{add:i}}),define("common/modules/commercial/comment-adverts",["fastdom","Promise","common/utils/_","common/utils/$","common/utils/config","common/utils/detect","common/utils/mediator","common/modules/identity/api","common/modules/experiments/ab","common/modules/commercial/create-ad-slot","common/modules/commercial/dfp"],function(e,t,o,n,i,s,r,a,c,m,l){return function(t){var u,d,p,h,f=o.defaults(t||{},{adSlotContainerSelector:".js-discussion__ad-slot",commentMainColumn:".content__main-column"});return d=n(f.adSlotContainerSelector),p=n(f.commentMainColumn,".js-comments"),i.switches.standardAdverts&&c.shouldRunTest("Viewability","variant")&&d.length&&i.switches.discussion&&a.isUserLoggedIn()&&(!i.page.isLiveBlog||"wide"===s.getBreakpoint())&&i.page.commentable?void r.once("modules:comments:renderComments:rendered",function(){e.read(function(){return p.dim().height<280?!1:void e.write(function(){p.addClass("discussion__ad-wrapper"),i.page.isLiveBlog||p.addClass("discussion__ad-wrapper-wider"),u="comments",h=n(m(u,"mpu-banner-ad")),d.append(h),l.addSlot(h)})})}):!1}}),define("common/utils/easing",[],function(){function e(e,o){var n=new Date,i=t[e];return function(){var e=new Date-n;return i(Math.min(1,e/o))}}var t={linear:function(e){return e},easeInQuad:function(e){return e*e},easeOutQuad:function(e){return e*(2-e)},easeInOutQuad:function(e){return.5>e?2*e*e:-1+(4-2*e)*e},easeInCubic:function(e){return e*e*e},easeOutCubic:function(e){return--e*e*e+1},easeInOutCubic:function(e){return.5>e?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1},easeInQuart:function(e){return e*e*e*e},easeOutQuart:function(e){return 1- --e*e*e*e},easeInOutQuart:function(e){return.5>e?8*e*e*e*e:1-8*--e*e*e*e},easeInQuint:function(e){return e*e*e*e*e},easeOutQuint:function(e){return 1+--e*e*e*e*e},easeInOutQuint:function(e){return.5>e?16*e*e*e*e*e:1+16*--e*e*e*e*e}};return{functions:t,create:e}}),define("common/utils/scroller",["common/utils/easing","bonzo","fastdom"],function(e,t,o){function n(n,i,s){var r=t(document.body),a=n,c=r.scrollTop(),m=a-c,l=e.create(s||"easeOutQuad",i),u=function(){o.write(function(){r.scrollTop(c+l()*m)})},d=window.setInterval(u,15);window.setTimeout(function(){window.clearInterval(d),o.write(function(){r.scrollTop(a)})},i)}function i(e,o,i){var s=t(e).offset().top;n(s,o,i)}return{scrollToElement:i,scrollTo:n}}),define("common/modules/analytics/discussion",["bonzo","common/utils/_","common/utils/$","common/utils/mediator","common/modules/analytics/omniture","common/modules/identity/api"],function(e,t,o,n,i,r){var a={};return a.seen=!1,a.getLinkTrackVars=function(e){e=e||[];var t=["prop6","prop19","prop75","eVar8","eVar19","eVar31","eVar51","eVar66"];return","+t.concat(e).join(",")},a.comment=function(e){i.populateEventProperties("comment"),s.events+=",event51",s.linkTrackVars+=this.getLinkTrackVars(["eVar68"]),s.linkTrackEvents+=",event51",s.eVar66=r.getUserFromCookie().id||null,s.eVar68=e.replyTo?"response":"comment",s.eVar67=e.replyTo?e.replyTo.authorId:null,s.tl(!0,"o","comment")},a.recommend=function(e){i.populateEventProperties("Recommend a comment"),s.events+=",event72",s.linkTrackVars+=this.getLinkTrackVars(["eVar65","eVar67"]),s.linkTrackEvents+=",event72",s.eVar65="recommendation",s.eVar66=r.getUserFromCookie()?r.getUserFromCookie().id:null,s.eVar67=e.userId,s.tl(!0,"o","Recommend a comment")},a.jumpedToComments=function(){a.seen||(i.populateEventProperties("seen jump-to-comments"),s.events+=",event72",s.linkTrackVars+=this.getLinkTrackVars(["eVar65"]),s.linkTrackEvents+=",event72",s.eVar65="seen jump-to-comments",s.eVar66=r.getUserFromCookie()?r.getUserFromCookie().id:null,s.tl(!0,"o","seen jump-to-comments"),a.seen=!0)},a.commentPermalink=function(){a.seen||(i.populateEventProperties("seen comment-permalink"),s.events+=",event72",s.linkTrackVars+=this.getLinkTrackVars(["eVar65"]),s.linkTrackEvents+=",event72",s.eVar65="seen comment-permalink",s.eVar66=r.getUserFromCookie()?r.getUserFromCookie().id:null,s.tl(!0,"o","seen comment-permalink"),a.seen=!0)},a.scrolledToComments=function(){a.seen||(i.populateEventProperties("seen scroll-top"),s.events+=",event72",s.linkTrackVars+=this.getLinkTrackVars(["eVar65"]),s.linkTrackEvents+=",event72",s.eVar65="seen scroll-top",s.eVar66=r.getUserFromCookie()?r.getUserFromCookie().id:null,s.tl(!0,"o","seen scroll-top"),a.seen=!0)},a.areCommentsSeen=function(){var e,o=function(){a.seen||e||!a.areCommentsVisible()||(a.scrolledToComments(),n.off("window:scroll",t.debounce(o,200)))};a.seen||n.on("window:scroll",t.debounce(o,200))},a.areCommentsVisible=function(){var t=o("#comments").offset(),n=o("body").first().scrollTop(),i=e.viewport().height;return t.top-i/2<n&&t.top+t.height-i/3>n?!0:!1},{init:function(){n.on("discussion:commentbox:post:success",a.comment.bind(a)),n.on("discussion:comment:recommend:success",a.recommend.bind(a)),n.on("discussion:seen:comment-permalink",a.commentPermalink.bind(a)),n.on("discussion:seen:comments-anchor",a.jumpedToComments.bind(a)),n.on("discussion:seen:comments-scrolled-to",a.scrolledToComments.bind(a)),a.areCommentsSeen()}}}),define("common/modules/discussion/api",["common/modules/user-prefs","common/utils/ajax","common/utils/config","common/utils/cookies"],function(e,t,o,n){var i="https:"===document.location.protocol?o.page.secureDiscussionApiRoot:o.page.discussionApiRoot,s={root:i,proxyRoot:o.switches.discussionProxy?o.page.host+"/guardianapis/discussion/discussion-api":i,clientHeader:o.page.discussionApiClientHeader};return s.send=function(e,o,i,r){var a=r?s.proxyRoot:s.root;i=i||{},n.get("GU_U")&&(i.GU_U=n.get("GU_U"));var c=t({url:a+e,type:"get"===o?"jsonp":"json",method:o,crossOrigin:!0,data:i,headers:{"D2-X-UID":"zHoBy6HNKsk","GU-Client":s.clientHeader}});return c},s.postComment=function(e,t){var o="/discussion/"+e+"/comment"+(t.replyTo?"/"+t.replyTo.commentId+"/reply":"");return s.send(o,"post",t,!0)},s.previewComment=function(e){var t="/comment/preview";return s.send(t,"post",e)},s.recommendComment=function(e){var t="/comment/"+e+"/recommend";return s.send(t,"post")},s.pickComment=function(e){var t="/comment/"+e+"/highlight";return s.send(t,"post")},s.unPickComment=function(e){var t="/comment/"+e+"/unhighlight";return s.send(t,"post")},s.reportComment=function(e,t){var o="/comment/"+e+"/reportAbuse";return s.send(o,"post",t)},s.getUser=function(e){var t="/profile/"+(e?e:"me");return s.send(t,"get")},s}),define("common/modules/discussion/user-avatars",["common/utils/$","bonzo","common/modules/discussion/api"],function(e,t,o){function n(){e(".user-avatar").each(i)}function i(e){var n=t(e),i=t(t.create('<div class="is-updating"></div>')),s=t(t.create('<img class="user-avatar__image" alt="" />')),r=n.data("userid");n.removeClass("is-hidden"),i.css("display","block").appendTo(n),o.getUser(r).then(function(e){s.attr("src",e.userProfile.secureAvatarUrl),i.remove(),s.appendTo(n)})}return{init:n,avatarify:i}}),define("common/modules/identity/validation-email",["bean","bonzo","common/utils/mediator","common/modules/identity/api"],function(e,t,o,n){return{init:function(){var i,s=document.body.querySelector(".js-id-send-validation-email");s&&(i=t(s),e.on(s,"click",function(e){e.preventDefault(),n.isUserLoggedIn()&&n.sendValidationEmail().then(function(e){"error"===e.status?(o.emit("module:identity:validation-email:fail"),i.innerHTML="An error occured, please click here to try again."):(o.emit("module:identity:validation-email:success"),i.replaceWith("<p>Sent. Please check your email and follow the link.</p>"))},function(){o.emit("module:identity:validation-email:fail"),i.innerHTML="An error occured, please click here to try again."})}))}}}),define("common/modules/discussion/comment-box",["common/utils/$","bean","bonzo","common/utils/config","common/utils/mediator","common/modules/analytics/beacon","common/modules/discussion/api","common/modules/identity/api","common/modules/component","common/modules/discussion/user-avatars","common/modules/identity/validation-email"],function(e,t,o,n,i,s,r,a,c,m,l){function u(e){this.setOptions(e),i.on("module:identity:validation-email:success",this.verificationEmailSuccess.bind(this)),i.on("module:identity:validation-email:fail",this.verificationEmailFail.bind(this))}return c.define(u),u.prototype.useBem=!0,u.prototype.templateName="comment-box",u.prototype.componentClass="d-comment-box",u.prototype.classes={},u.prototype.errorMessages={EMPTY_COMMENT_BODY:"Please write a comment.",COMMENT_TOO_LONG:"Your comment must be fewer than 5000 characters long.",HTTP_420:"You can only post one comment every minute. Please try again in a moment.",HTTP_0:"Could not post due to your internet settings, which might be controlled by your provider. Please contact your administrator or disable any proxy servers or VPNs and try again.",USER_BANNED:'Commenting has been disabled for this account (<a href="/community-faqs#321a">why?</a>).',API_ERROR:"Sorry, there was a problem posting your comment.  Please try another browser or network connection.  Reference code ",EMAIL_VERIFIED:'<span class="d-comment-box__error-meta">Sent. Please check your email to verify  your email address. Once verified post your comment.</span>',EMAIL_VERIFIED_FAIL:'We are having technical difficulties. Please try again later or <a href="/send/email" class="js-id-send-validation-email"><strong>resend the verification</strong></a>.',EMAIL_NOT_VERIFIED:'Please confirm your email address to post your first comment.<br />If you can\'t find the email, we can <a href="_#" class="js-id-send-validation-email"><strong>resend the verification email</strong></a><span class="d-comment-box__error-meta"> to  your email address.</span>'},u.prototype.defaultOptions={discussionId:null,apiRoot:null,maxLength:5e3,premod:!1,focus:!1,state:"top-level",replyTo:null,priorToVerificationDate:new Date(1392719401337)},u.prototype.errors=[],u.prototype.getUserData=function(){return a.getUserFromCookie()},u.prototype.prerender=function(){this.options.premod||this.getElem("premod").parentNode.removeChild(this.getElem("premod"));var e=this.getUserData();if(this.getElem("author").innerHTML=e.displayName,"response"===this.options.state)this.getElem("submit").innerHTML="Post reply";else{var t=this.getElem("avatar-wrapper");t.setAttribute("userid",e.id),m.avatarify(t)}if(this.options.replyTo){var o=this.getElem("reply-to-author");o.innerHTML=this.options.replyTo.author,this.getElem("parent-comment-author").innerHTML=this.options.replyTo.author+" @ "+this.options.replyTo.timestamp+" said:",this.getElem("parent-comment-body").innerHTML=this.options.replyTo.body;var n=function(){var e=o.offsetLeft+o.getBoundingClientRect().width/2;this.getElem("parent-comment-spout").style.marginLeft=e+"px"};window.setTimeout(n.bind(this),0)}},u.prototype.ready=function(){if(null===this.getDiscussionId())throw new Error('CommentBox: You need to set the "data-discussion-key" on your element');var e=this.getElem("body");this.setFormState(),t.on(document.body,"submit",[this.elem],this.postComment.bind(this)),t.on(document.body,"change keyup",[e],this.setFormState.bind(this)),t.on(e,"focus",this.setExpanded.bind(this)),this.on("change",".d-comment-box__body",this.resetPreviewComment),this.on("click",this.getClass("preview"),this.previewComment),this.on("click",this.getClass("hide-preview"),this.resetPreviewComment),this.on("click",this.getClass("cancel"),this.cancelComment),this.on("click",this.getClass("show-parent"),this.setState.bind(this,"parent-visible",!1)),this.on("click",this.getClass("hide-parent"),this.removeState.bind(this,"parent-visible",!1)),this.on("click",this.getClass("formatting-bold"),this.formatComment.bind(this,"bold")),this.on("click",this.getClass("formatting-italic"),this.formatComment.bind(this,"italic")),this.on("click",this.getClass("formatting-quote"),this.formatComment.bind(this,"quote")),this.on("click",this.getClass("formatting-link"),this.formatComment.bind(this,"link")),this.setState(this.options.state),this.options.focus&&window.setTimeout(function(){this.getElem("body").focus()}.bind(this),0)},u.prototype.urlify=function(e){var t="(?![^<]*>|[^<>]*</)",o="\\b((https?://|www.)\\S+)\\b",n=new RegExp(o+t,"g");return e.replace(n,function(e,t,o){var n="www."===o?"http://"+t:t;return'<a href="'+n+'">'+t+"</a>"})},u.prototype.postComment=function(e){var t=this,o={body:this.elem.body.value};e.preventDefault(),t.clearErrors();var n=function(){""===o.body&&t.error("EMPTY_COMMENT_BODY"),o.body.length>t.options.maxLength&&t.error("COMMENT_TOO_LONG","<b>Comments must be shorter than "+t.options.maxLength+" characters.</b>Yours is currently "+(o.body.length-t.options.maxLength)+" character(s) too long."),t.options.replyTo&&(o.replyTo=t.options.replyTo),0===t.errors.length&&(o.body=t.urlify(o.body),t.setFormState(!0),r.postComment(t.getDiscussionId(),o).then(t.postCommentSuccess.bind(t,o),t.fail.bind(t)))},i=function(){t.error("EMAIL_NOT_VERIFIED"),l.init()};if(t.getUserData().emailVerified)n();else{var s=new Date(t.getUserData().accountCreatedDate);s>t.options.priorToVerificationDate?a.getUserFromApiWithRefreshedCookie().then(function(e){e.user.statusFields.userEmailValidated===!0?n():i()}):n()}},u.prototype.error=function(e,t){"HTTP_0"===e?s.counts("comment-http-proxy-error","comment-error"):s.counts("comment-error"),t=t||this.errorMessages[e],this.setState("invalid");var n=o.create('<div class="d-discussion__error '+this.getClass("error",!0)+'"><i class="i i-alert"></i><span class="d-discussion__error-text">'+t+"</span></div>")[0];this.getElem("messages").appendChild(n),this.errors.push(e)},u.prototype.postCommentSuccess=function(e,t){s.counts("comment-post-success"),e.id=parseInt(t.message,10),this.getElem("body").value="",this.resetPreviewComment(),this.setFormState(),this.emit("post:success",e),i.emit("discussion:commentbox:post:success",e)},u.prototype.fail=function(e){var t;try{t=JSON.parse(e.responseText)}catch(o){t={}}this.setFormState(),this.errorMessages["HTTP_"+e.status]?this.error("HTTP_"+e.status):this.errorMessages[t.errorCode]?this.error(t.errorCode):this.error("API_ERROR",this.errorMessages.API_ERROR+e.status)},u.prototype.previewCommentSuccess=function(e,t){this.getElem("preview-body").innerHTML=t.commentBody,this.setState("preview-visible")},u.prototype.getDiscussionId=function(){return this.options.discussionId||this.elem.getAttribute("data-discussion-key").replace("discussion","")},u.prototype.setFormState=function(e){e="boolean"==typeof e?e:!1;var t=this.getElem("body"),o=this.getElem("submit");e||0===t.value.length?o.setAttribute("disabled","disabled"):o.removeAttribute("disabled")},u.prototype.clearErrors=function(){this.getElem("messages").innerHTML="",this.errors=[],this.removeState("invalid")},u.prototype.setExpanded=function(){this.setState("expanded")},u.prototype.verificationEmailSuccess=function(){this.clearErrors(),this.error("EMAIL_VERIFIED")},u.prototype.verificationEmailFail=function(){this.clearErrors(),this.error("EMAIL_VERIFIED_FAIL")},u.prototype.previewComment=function(e){var t=this,o={body:this.getElem("body").value};e.preventDefault(),t.clearErrors(),""===o.body&&(this.resetPreviewComment(),t.error("EMPTY_COMMENT_BODY")),o.body.length>t.options.maxLength&&t.error("COMMENT_TOO_LONG","<b>Comments must be shorter than "+t.options.maxLength+" characters.</b>Yours is currently "+(o.body.length-t.options.maxLength)+" characters too long."),0===t.errors.length&&r.previewComment(o).then(t.previewCommentSuccess.bind(t,o),t.fail.bind(t))},u.prototype.cancelComment=function(){"response"===this.options.state?this.destroy():(this.resetPreviewComment(),this.getElem("body").value="",this.setFormState(),this.removeState("expanded"))},u.prototype.resetPreviewComment=function(){this.removeState("preview-visible"),this.getElem("preview-body").innerHTML=""},u.prototype.formatComment=function(e){var t=this.getElem("body"),o=t.selectionStart,n=t.value.substring(t.selectionStart,t.selectionEnd),i=function(e,o){var i=e+n+o;t.value=t.value.substring(0,t.selectionStart)+i+t.value.substring(t.selectionEnd),r(i)},s=function(){var e,o;/^https?:\/\//i.test(n)?e=n:(o=window.prompt("Your URL:","http://www."),e=o,n=n||o);
var i='<a href="'+e+'">'+n+"</a>";t.value=t.value.substring(0,t.selectionStart)+i+t.value.substring(t.selectionEnd)},r=function(e){t.setSelectionRange(o,o+e.length)};switch(e){case"bold":i("<b>","</b>");break;case"italic":i("<i>","</i>");break;case"quote":i("<blockquote>","</blockquote>");break;case"link":s()}},u}),define("common/modules/discussion/whole-discussion",["bean","bonzo","qwery","Promise","common/utils/$","common/utils/_","common/utils/ajax-promise"],function(e,t,o,n,i,s,r){function a(e,t){return new n(function(o){function n(){c--,a.length?i(a.shift()):c||o()}function i(t){c++,e.call(null,t).then(n,n)}if(!t||!t.length)return void o();var r=t.splice(0,l),a=t,c=0;s.forEach(r,i)})}function c(e){this.discussionId=e.discussionId,this.discussion=[],this.params={orderBy:e.orderBy,displayThreaded:e.displayThreaded,maxResponses:e.maxResponses}}var m=50,l=3,u=1e3;return c.prototype.firstPageLoaded=function(e){if(this.storeCommentPage(e,1),this.discussionContainer=t.create(e.commentsHtml),this.commentsThread=i(".d-thread--comments",this.discussionContainer).empty(),this.postedCommentHtml=e.postedCommentHtml,this.lastPage=e.lastPage,e.commentCount>u)throw new Error("Discussion comment count too large");return s.range(2,this.lastPage+1)},c.prototype.storeCommentPage=function(e,o){var n=i(".d-thread--comments",t.create(e.commentsHtml)),s=i(".d-comment--top-level",n);"newest"===this.params.orderBy&&(s=s.map(function(e){return e}).reverse()),this.discussion[o]=s},c.prototype.loadPage=function(e){var t={orderBy:"oldest",page:e,pageSize:m,displayThreaded:this.params.displayThreaded};return this.params.maxResponses&&(t.maxResponses=this.params.maxResponses),r({url:"/discussion/"+this.discussionId+".json",type:"json",method:"get",crossOrigin:!0,data:t})},c.prototype.loadPageAndStore=function(e){return this.loadPage(e).then(function(t){this.storeCommentPage(t,e)}.bind(this))},c.prototype.loadRemainingPages=function(e){return a(this.loadPageAndStore.bind(this),e)},c.prototype.makeDiscussionResponseObject=function(){return"newest"===this.params.orderBy&&this.discussion.reverse(),this.discussion.reduce(function(e,t){return e.append(t),e},this.commentsThread),{paginationHtml:"",postedCommentHtml:this.postedCommentHtml,commentsHtml:this.discussionContainer.html(),lastPage:this.lastPage}},c.prototype.loadAllComments=function(){return this.loadPage(1).then(this.firstPageLoaded.bind(this)).then(this.loadRemainingPages.bind(this)).then(this.makeDiscussionResponseObject.bind(this))},c}),define("common/modules/discussion/comments",["bean","bonzo","qwery","common/utils/$","common/utils/ajax-promise","common/utils/config","common/utils/mediator","common/utils/scroller","common/modules/component","common/modules/discussion/api","common/modules/discussion/comment-box","common/modules/discussion/whole-discussion","common/modules/ui/relativedates"],function(e,t,o,n,i,s,r,a,c,m,l,u,d){var p=function(e){this.setOptions(e)};return c.define(p),p.prototype.componentClass="d-comments",p.prototype.classes={comments:"d-thread--top-level",topLevelComment:"d-comment--top-level",reply:"d-comment--response",showReplies:"d-show-more-replies",showRepliesButton:"d-show-more-replies__button",newComments:"js-new-comments",comment:"d-comment",commentReply:"d-comment__action--reply",commentPick:"d-comment__action--pick",commentStaff:"d-comment--staff",commentBody:"d-comment__body",commentTimestampJs:"js-timestamp",commentReport:"js-report-comment"},p.prototype.defaultOptions={discussionId:null,showRepliesCount:3,commentId:null,order:"newest",threading:"collapsed"},p.prototype.comments=null,p.prototype.topLevelComments=null,p.prototype.user=null,p.prototype.ready=function(){this.topLevelComments=o(this.getClass("topLevelComment"),this.elem),this.comments=o(this.getClass("comment"),this.elem),this.on("click",this.getClass("showRepliesButton"),this.getMoreReplies),this.on("click",this.getClass("commentReport"),this.reportComment),window.setInterval(function(){this.relativeDates()}.bind(this),6e4),this.emit("ready"),this.relativeDates(),this.on("click",".js-report-comment-close",function(){n(".js-report-comment-form").addClass("u-h")})},p.prototype.handlePickClick=function(e){e.preventDefault();var t=e.target.getAttribute("data-comment-id"),o=n(e.target),i="true"===o[0].getAttribute("data-comment-highlighted")?this.unPickComment.bind(this):this.pickComment.bind(this);i(t,o).fail(function(t){var o=t.response.length>0?JSON.parse(t.response).message:t.statusText;n(e.target).text(o)})},p.prototype.pickComment=function(e,t){var i=this,s=o("#comment-"+e,this.elem);return m.pickComment(e).then(function(){n(i.getClass("commentPick"),s).removeClass("u-h"),t.text("Unpick"),s.setAttribute("data-comment-highlighted",!0)})},p.prototype.unPickComment=function(e,t){var i=this,s=o("#comment-"+e);return m.unPickComment(e).then(function(){n(i.getClass("commentPick"),s).addClass("u-h"),t.text("Pick"),s.setAttribute("data-comment-highlighted",!1)})},p.prototype.fetchComments=function(e){e=e||{};var t="/discussion/"+(e.comment?"comment-context/"+e.comment:this.options.discussionId)+".json?"+(e.page?"&page="+e.page:""),o={orderBy:e.order||this.options.order,pageSize:e.pagesize||this.options.pagesize,displayThreaded:"unthreaded"!==this.options.threading};e.comment||"collapsed"!==this.options.threading||(o.maxResponses=3);var n,s={url:t,type:"json",method:"get",crossOrigin:!0,data:o};return this.isAllPageSizeActive()?n=new u({discussionId:this.options.discussionId,orderBy:o.orderBy,displayThreaded:o.displayThreaded,maxResponses:o.maxResponses}).loadAllComments().catch(function(){return this.wholeDiscussionErrors=!0,o.pageSize=100,i(s)}.bind(this)):("All"===o.pageSize&&(o.pageSize=100),n=i(s)),n.then(this.renderComments.bind(this)).then(this.goToPermalink.bind(this,e.comment))},p.prototype.goToPermalink=function(e){e&&(this.showHiddenComments(),n(".d-discussion__show-all-comments").addClass("u-h"),window.location.replace("#comment-"+e))},p.prototype.renderComments=function(e){var n=t.create(e.commentsHtml),i=o(this.getClass("comment"),n);t(this.elem).empty().append(n),this.addMoreRepliesButtons(i),this.postedCommentEl=e.postedCommentHtml,this.relativeDates(),this.emit("rendered",e.paginationHtml),r.emit("modules:comments:renderComments:rendered")},p.prototype.showHiddenComments=function(e){e&&e.preventDefault(),this.emit("first-load"),this.relativeDates()},p.prototype.addMoreRepliesButtons=function(e){e=e||this.topLevelComments,e.forEach(function(e){var t=parseInt(e.getAttribute("data-comment-replies"),10),i=o(this.getClass("reply"),e);if(i.length<t){var s=t-i.length,r=n.create('<button class="u-button-reset button button--show-more button--small button--tone-news d-show-more-replies__button"><i class="i i-plus-blue"></i>Show '+s+" more "+(1===s?"reply":"replies")+"</button>").attr({"data-link-name":"Show more replies","data-is-ajax":"","data-comment-id":e.getAttribute("data-comment-id")}).data("source-comment",e);n.create('<li class="'+this.getClass("showReplies",!0)+'"></li>').append(r).appendTo(n(".d-thread--responses",e))}}.bind(this))},p.prototype.getMoreReplies=function(e){e.preventDefault();var s=n.ancestor(e.currentTarget,this.getClass("showReplies").slice(1));s.innerHTML="Loading…";var r=t(e.target).data("source-comment");i({url:"/discussion/comment/"+e.currentTarget.getAttribute("data-comment-id")+".json",type:"json",method:"get",data:{displayThreaded:!0},crossOrigin:!0}).then(function(e){var n=t.create(e.html),i=o(this.getClass("reply"),n);i=i.slice(this.options.showRepliesCount),t(o(".d-thread--responses",r)).append(i),t(s).addClass("u-h"),this.emit("untruncate-thread"),this.relativeDates()}.bind(this))},p.prototype.isReadOnly=function(){return"true"===this.elem.getAttribute("data-read-only")},p.prototype.addComment=function(e,i,s){var r,a,c,m,l,u={username:"d-comment__author",timestamp:"js-timestamp",body:"d-comment__body",report:"d-comment__action--report",avatar:"d-comment__avatar"},d={username:this.user.displayName,timestamp:"Just now",body:"<p>"+e.body.replace(/\n+/g,"</p><p>")+"</p>",report:{href:"http://discussion.theguardian.com/components/report-abuse/"+e.id},avatar:{src:this.user.avatar}},p=t.create(this.postedCommentEl)[0],h=t(p);h.addClass("d-comment--new");for(r in u)if(u.hasOwnProperty(r))if(c=u[r],a=d[r],m=o("."+c,p)[0],"string"==typeof a)m.innerHTML=a;else for(l in a)m.setAttribute(l,a[l]);p.id="comment-"+e.id,this.user&&!this.user.isStaff&&h.addClass(this.getClass("commentStaff",!0)),s?(h.removeClass(this.getClass("topLevelComment",!0)),h.addClass(this.getClass("reply",!0)),t(s).append(h)):n(this.getClass("newComments"),this.elem).prepend(p),window.location.replace("#comment-"+e.id)},p.prototype.replyToComment=function(e){e.preventDefault();var i,s,r=e.currentTarget,a=r.getAttribute("data-comment-id"),c=this;if(document.getElementById("reply-to-"+a))return void document.getElementById("reply-to-"+a).focus();n(".d-comment-box--response").remove();var m=o("#comment-"+a)[0],u=m.getAttribute("data-comment-author"),d=m.getAttribute("data-comment-author-id"),p=t(m),h=o(this.getClass("commentBody"),m)[0].innerHTML,f=o(this.getClass("commentTimestampJs"),m)[0].innerHTML,g=new l({discussionId:this.options.discussionId,premod:this.user.privateFields.isPremoderated,state:"response",replyTo:{commentId:a,author:u,authorId:d,body:h,timestamp:f},focus:!0});i=p.hasClass(this.getClass("topLevelComment",!0))?p[0]:p.parent().parent()[0],s=o(this.getClass("showReplies"),i),s.length>0&&!t(s).hasClass("u-h")&&s[0].click(),g.render(i),g.on("post:success",function(e){var n=o(".d-thread--responses",i)[0];n||(n=t.create('<ul class="d-thread d-thread--responses"></ul>')[0],t(i).append(n)),this.destroy(),c.addComment(e,!1,n)})},p.prototype.reportComment=function(o){o.preventDefault();var i=o.currentTarget.getAttribute("data-comment-id");n(".js-report-comment-form").first().each(function(o){e.one(o,"submit",function(e){e.preventDefault();var n=o.elements.category,s=o.elements.comment.value;"0"!==n.value&&m.reportComment(i,{emailAddress:o.elements.email.value,categoryId:n.value,reason:s}),t(o).addClass("u-h")})}).appendTo(n("#comment-"+i+" .js-report-comment-container").first()).removeClass("u-h")},p.prototype.addUser=function(e){this.user=e,this.user&&this.user.badge&&(this.user.isStaff=this.user.badge.some(function(e){return"Staff"===e.name})),this.isReadOnly()||this.user&&this.user.privateFields.canPostComment&&(n(this.getClass("commentReply")).attr("href","#"),this.on("click",this.getClass("commentReply"),this.replyToComment),this.on("click",this.getClass("commentPick"),this.handlePickClick))},p.prototype.relativeDates=function(){d.init()},p.prototype.isAllPageSizeActive=function(){return s.switches.discussionAllPageSize&&"All"===this.options.pagesize&&!this.wholeDiscussionErrors},p.prototype.shouldShowPageSizeMessage=function(){return s.switches.discussionAllPageSize&&"All"===this.options.pagesize&&this.wholeDiscussionErrors},p}),define("common/modules/discussion/loader",["bean","bonzo","qwery","raven","common/utils/$","common/utils/_","common/utils/ajax-promise","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/scroller","common/modules/analytics/discussion","common/modules/analytics/register","common/modules/component","common/modules/discussion/api","common/modules/discussion/comment-box","common/modules/discussion/comments","common/modules/identity/api","common/modules/user-prefs"],function(e,t,o,n,i,s,r,a,c,m,l,u,d,p,h,f,g,v,b){var y=function(){d.begin("discussion")};return p.define(y),y.prototype.classes={},y.prototype.componentClass="discussion",y.prototype.comments=null,y.prototype.user=null,y.prototype.initTopComments=function(){return this.on("click",".js-jump-to-comment",function(e){e.preventDefault(),l.scrollToElement(o(".js-discussion-toolbar"),100);var n=t(e.currentTarget).data("comment-id");this.loadComments({comment:n})}),r({url:"/discussion/top-comments/"+this.getDiscussionId()+".json",type:"json",method:"get",crossOrigin:!0}).then(function(e){this.$topCommentsContainer.html(e.html),this.topCommentCount=o(".d-top-comment",this.$topCommentsContainer[0]).length,0!==this.topCommentCount&&this.setState("has-top-comments")}.bind(this))},y.prototype.initMainComments=function(){var e=this.getCommentIdFromHash();e&&m.emit("discussion:seen:comment-permalink");var r=b.get("discussion.order")||(this.getDiscussionClosed()?"oldest":"newest"),l=b.get("discussion.threading")||"collapsed",u=c.isBreakpoint({min:"tablet"})?25:10;this.comments=new g({discussionId:this.getDiscussionId(),order:r,pagesize:u,threading:l}),this.comments.attachTo(o(".js-discussion-main-comments")[0]),this.comments.on("untruncate-thread",this.removeTruncation.bind(this)),this.on("click",".js-discussion-show-button, .d-show-more-replies__button, .js-discussion-author-link, .js-discussion-change-page",this.removeTruncation.bind(this)),this.comments.on("rendered",function(e){var n=t.create(e),s=o(".js-discussion-toolbar",this.elem)[0],r=i(".js-discussion-pagination",s).empty();this.comments.isAllPageSizeActive()||r.html(n)}.bind(this)),this.setState("loading"),this.on("user:loaded",function(){if(this.initState(),this.renderCommentBar(),this.user){this.comments.addUser(this.user);var t=b.get("discussion.pagesize"),o=u;s.isNumber(t)?o=t:"All"===t&&(o=a.switches.discussionAllPageSize?"All":100),this.initPageSizeDropdown(o),a.switches.discussionPageSize&&c.isBreakpoint({min:"tablet"})&&(this.comments.options.pagesize=o),this.user.isStaff&&(this.removeState("not-staff"),this.setState("is-staff"))}var i=!e&&"#comments"!==window.location.hash;this.loadComments({comment:e,shouldTruncate:i}).catch(function(e){var t="Comments failed to load: ",o=e.request;t+="Request is aborted: timeout"===e.message?"XHR timeout":e.message?e.message:"status"in o?o.status:"",n.captureMessage(t,{tags:{contentType:"comments",discussionId:this.getDiscussionId(),status:"status"in o?o.status:"",readyState:"readyState"in o?o.readyState:"",response:"response"in o?o.response:"",statusText:"status"in o?o.statusText:""}})}.bind(this))}),this.getUser()},y.prototype.initPageSizeDropdown=function(n){var s=i(".js-comment-pagesize");s.text(n),this.on("click",".js-comment-pagesize-dropdown .popup__action",function(n){e.fire(o(".js-comment-pagesize-dropdown [data-toggle]")[0],"click");var i=t(n.currentTarget).data("pagesize");this.comments.options.pagesize=i,s.text(i),b.set("discussion.pagesize",i),this.loadComments({page:1})})},y.prototype.initToolbar=function(){var n=i(".js-comment-order");n.text(this.comments.options.order),this.on("click",".js-comment-order-dropdown .popup__action",function(i){e.fire(o(".js-comment-order-dropdown [data-toggle]")[0],"click"),this.comments.options.order=t(i.currentTarget).data("order"),n.text(this.comments.options.order),b.set("discussion.order",this.comments.options.order),this.loadComments({page:1})});var s=i(".js-comment-threading");s.text(this.comments.options.threading),this.on("click",".js-comment-threading-dropdown .popup__action",function(n){e.fire(o(".js-comment-threading-dropdown [data-toggle]")[0],"click"),this.comments.options.threading=t(n.currentTarget).data("threading"),s.text(this.comments.options.threading),b.set("discussion.threading",this.comments.options.threading),this.loadComments()})},y.prototype.isOpenForRecommendations=function(){return 0!==o(".d-discussion--recommendations-open",this.elem).length},y.prototype.initRecommend=function(){this.on("click",".js-recommend-comment",function(e){if(this.user&&this.isOpenForRecommendations()){var o=e.currentTarget,n=t(o);n.removeClass("js-recommend-comment");var i=o.getAttribute("data-comment-id"),s=h.recommendComment(i);return n.addClass("d-comment__recommend--clicked"),s.then(n.addClass.bind(n,"d-comment__recommend--recommended"))}})},y.prototype.ready=function(){this.$topCommentsContainer=i(".js-discussion-top-comments"),this.initTopComments(),this.initMainComments(),this.initToolbar(),this.renderCommentCount(),this.initPagination(),this.initRecommend(),u.init(),e.on(window,"hashchange",function(){var e=this.getCommentIdFromHash();e&&this.gotoComment(e)}.bind(this)),"#comments"===window.location.hash&&m.emit("discussion:seen:comments-anchor"),m.on("discussion:commentbox:post:success",this.removeState.bind(this,"empty")),m.on("module:clickstream:click",function(e){"hash"in e.target&&"#comments"===e.target.hash&&this.removeTruncation()}.bind(this)),d.end("discussion")},y.prototype.getUser=function(){v.getUserFromCookie()?h.getUser().then(function(e){this.user=e.userProfile,this.emit("user:loaded")}.bind(this)):this.emit("user:loaded")},y.prototype.isCommentable=function(){var e=this.user&&this.user.privateFields&&this.user.privateFields.canPostComment;return e&&!this.comments.isReadOnly()&&!this.getDiscussionClosed()},y.prototype.initState=function(){this.setState(this.getDiscussionClosed()?"closed":this.comments.isReadOnly()?"readonly":v.getUserFromCookie()?this.user&&this.user.privateFields&&!this.user.privateFields.canPostComment?"banned":"open":"open")},y.prototype.renderCommentBar=function(){this.isCommentable()&&(this.renderCommentBox(o(".js-discussion-comment-box--top")[0]),this.renderCommentBox(o(".js-discussion-comment-box--bottom")[0]))},y.prototype.commentPosted=function(){this.removeState("truncated"),this.comments.addComment.apply(this.comments,arguments)},y.prototype.renderCommentBox=function(e){return new f({discussionId:this.getDiscussionId(),premod:this.user.privateFields.isPremoderated}).render(e).on("post:success",this.commentPosted.bind(this))},y.prototype.getDiscussionId=function(){return this.elem.getAttribute("data-discussion-key")},y.prototype.getDiscussionClosed=function(){return"true"===this.elem.getAttribute("data-discussion-closed")},y.prototype.renderCommentCount=function(){r({url:"/discussion/comment-counts.json?shortUrls="+this.getDiscussionId(),type:"json",method:"get",crossOrigin:!0,success:function(e){if(e&&e.counts&&e.counts.length){var n=e.counts[0].count;if(n>0){t(o(".js-show-discussion, .js-show-discussion a")).attr("href","#comments");var s=1===n?"comment":"comments",r='<a href="#comments" class="js-show-discussion commentcount tone-colour" data-link-name="Comment count">  <i class="i"></i>'+n+'  <span class="commentcount__label">'+s+"</span></a>";i(".js-comment-count").html(r),i(".js-discussion-comment-count").text("("+n+")")}else this.setState("empty")}}.bind(this)})},y.prototype.getCommentIdFromHash=function(){var e=/#comment-(\d+)/;return e.exec(window.location.hash)?parseInt(e.exec(window.location.hash)[1],10):null},y.prototype.initPagination=function(){this.on("click",".js-discussion-change-page",function(e){e.preventDefault();var t=parseInt(e.currentTarget.getAttribute("data-page"),10);this.setState("loading"),this.gotoPage(t)})},y.prototype.gotoComment=function(e){var t=i("#comment-"+e,this.elem);return t.length>0?void window.location.replace("#comment-"+e):void this.loadComments({comment:e}).then(function(){window.location.replace("#comment-"+e)})},y.prototype.gotoPage=function(e){l.scrollToElement(o(".js-discussion-toolbar"),100),this.comments.relativeDates(),this.loadComments({page:e})},y.prototype.loadComments=function(e){return this.setState("loading"),e&&e.shouldTruncate&&this.comments.isAllPageSizeActive()&&(e.pageSize=10),this.comments.fetchComments(e).then(function(){this.removeState("loading"),e&&e.shouldTruncate?this.setState("truncated"):this.removeState("truncated"),this.comments.shouldShowPageSizeMessage()?this.setState("pagesize-msg-show"):this.removeState("pagesize-msg-show")}.bind(this))},y.prototype.removeTruncation=function(){this.comments.isAllPageSizeActive()?this.loadComments():this.removeState("truncated")},y}),define("common/modules/onward/onward-content",["common/utils/_","common/utils/config","common/utils/mediator","common/modules/analytics/register","common/modules/commercial/badges","common/modules/component"],function(e,t,o,n,i,s){function r(e){n.begin("series-content"),this.context=e,this.endpoint="/series/"+a()+".json?shortUrl="+encodeURIComponent(t.page.shortUrl),this.fetch(this.context,"html")}var a=function(){var o=t.page.blogIds.split(",").concat([t.page.seriesId]);return e.union(t.page.nonKeywordTagIds.split(","),o).shift()};return s.define(r),r.prototype.ready=function(e){i.add(e),n.end("series-content"),o.emit("modules:onward:loaded"),o.emit("page:new-content"),o.emit("ui:images:upgradePictures")},r.prototype.error=function(){n.error("series-content")},r}),define("common/modules/onward/popular",["common/utils/_","qwery","common/utils/$","common/utils/config","common/modules/component","common/utils/mediator","common/modules/commercial/create-ad-slot","common/modules/commercial/dfp"],function(e,t,o,n,i,s,r,a){function c(){var t=["info","global"];s.emit("register:begin","popular-in-section"),this.hasSection=n.page&&n.page.section&&!e.contains(t,n.page.section),this.endpoint="/most-read"+(this.hasSection?"/"+n.page.section:"")+".json"}return i.define(c),c.prototype.init=function(){this.fetch(t(".js-popular-trails"),"html")},c.prototype.prerender=function(){this.$mpu=n.page.shouldHideAdverts?void 0:o(".js-fc-slice-mpu-candidate",this.elem).append(r("mostpop","container-inline"))},c.prototype.ready=function(){this.$mpu&&(a.addSlot(o(".ad-slot",this.$mpu)),this.$mpu.removeClass("fc-slice__item--no-mpu")),s.emit("modules:popular:loaded",this.elem),s.emit("page:new-content",this.elem),s.emit("register:end","popular-in-section")},c}),define("common/modules/ui/expandable",["common/utils/$","bean","bonzo"],function(e,t,o){var n=function(n){var i=n||{},s=e(i.dom),r=i.expanded===!1?!1:!0,a=document.createElement("button"),c=i.showCount===!1?!1:!0,m={updateCallToAction:function(){var e="Show ";c&&(e+=l.getCount()+" "),e+=r?"fewer":"more",a.innerHTML=e,a.setAttribute("data-link-name","Show "+(r?"more":"fewer")),a.setAttribute("data-is-ajax","1")},renderState:function(){r?s.removeClass("shut"):s.addClass("shut")},renderCallToAction:function(){t.add(a,"click",function(){l.toggleExpanded()}),a.className="cta",i.buttonAfterEl?o(i.buttonAfterEl).after(a):s[0].appendChild(a),m.updateCallToAction()},scrollToCallToAction:function(){r||window.setTimeout(function(){a.scrollIntoView()},550)}},l={toggleExpanded:function(){r=r?!1:!0,m.renderState(),m.updateCallToAction()},getCount:function(){return parseInt(s.attr("data-count"),10)},isOpen:function(){return s.hasClass("shut")?!1:!0}};return{init:function(){return s.hasClass("expandable-initialised")||!s.html()||l.getCount()<3?!1:(s.addClass("expandable-initialised"),m.renderCallToAction(),void m.renderState())},toggle:l.toggleExpanded}};return n}),define("common/modules/onward/related",["bonzo","qwery","common/utils/_","common/utils/$","common/utils/config","common/utils/mediator","common/modules/analytics/register","common/modules/lazyload","common/modules/ui/expandable"],function(e,t,o,n,i,s,r,a,c){function m(e){l=e||{}}var l;return m.prototype.popularInTagOverride=function(){if(!i.page.keywordIds)return!1;var e=["sport/cricket","sport/rugby-union","sport/rugbyleague","sport/formulaone","sport/tennis","sport/cycling","sport/motorsports","sport/golf","sport/horse-racing","sport/boxing","sport/us-sport","sport/australia-sport","football/championsleague","football/premierleague","football/championship","football/europeanfootball","football/world-cup-2014","football/manchester-united","football/chelsea","football/arsenal","football/manchestercity","football/tottenham-hotspur","football/liverpool"],t=i.page.keywordIds.split(","),n=i.page.isAdvertisementFeature?t:o.intersection(e,t);return n.length?"/popular-in-tag/"+n[0]+".json":void 0},m.prototype.renderRelatedComponent=function(){var t,m,u,d,p=i.switches.relatedContent&&i.page.showRelatedContent;i.page&&i.page.hasStoryPackage?new c({dom:document.body.querySelector(".related-trails"),expanded:!1,showCount:!1}).init():p?(d=document.body.querySelector(".js-related"),d&&(m=this.popularInTagOverride(),u=m?"related-popular-in-tag":"related-content",r.begin(u),d.setAttribute("data-component",u),t=m||"/related/"+i.page.pageId+".json",l.excludeTags&&l.excludeTags.length&&(t+="?"+o.map(l.excludeTags,function(e){return"exclude-tag="+e}).join("&")),new a({url:t,container:d,success:function(){var e=d.querySelector(".related-content");new c({dom:e,expanded:!1,showCount:!1}).init(),s.emit("modules:related:loaded",d),s.emit("page:new-content",d),r.end(u)},error:function(){e(d).remove(),r.error(u)}}).load())):n(".js-related").addClass("u-h")},m}),define("common/modules/onward/tonal",["common/utils/config","common/utils/mediator","common/modules/analytics/register","common/modules/component"],function(e,t,o,n){function i(){o.begin("tonal-content"),this.edition=e.page.edition.toLowerCase(),this.isSupported()?this.endpoint=this.getEndpoint():this.fetch=s}var s=function(){};return n.define(i),i.prototype.tones={features:"-alpha/features/feature-stories.json",comment:"-alpha/contributors/feature-stories.json"},i.prototype.getEndpoint=function(){return"/container/"+this.edition+this.tones[this.getTone()]},i.prototype.isSupported=function(){return this.getTone()in this.tones},i.prototype.getTone=function(){return e.page.tones.split(",")[0].toLowerCase()},i.prototype.ready=function(){var e=document.body.querySelector(".tone-feature");t.emit("page:new-content",e),t.emit("ui:images:upgradePictures"),o.end("tonal-content")},i.prototype.error=function(){o.error("tonal-content")},i}),define("text!common/views/content/share-count.html",[],function(){return'<h3 class="sharecount__heading"><i class="i"></i>Shares</h3>\n<div class="sharecount__value sharecount__value--full">0</div>\n<div class="sharecount__value sharecount__value--short">0</div>'}),define("common/modules/social/share-count",["raven","common/utils/$","common/utils/ajax","common/utils/detect","common/utils/config","common/utils/formatters","common/utils/template","text!common/views/content/share-count.html"],function(e,t,o,n,i,s,r,a){function c(e){if(0!==e){p+=e;var t=p.toFixed(0),o=s.integerCommas(t),n=t>1e4?Math.round(t/1e3)+"k":t;u.text(o),d.text(n)}}function m(){h.attr("title",r(f,g))}function l(e){if(h.removeClass("u-h").html(a).css("display",""),d=t(".sharecount__value--short",h[0]),u=t(".sharecount__value--full",h[0]),n.isBreakpoint({min:"tablet"}))var o=250,i=25,s=o/i,r=e/s,m=0,l=window.setInterval(function(){c(r),++m===s&&window.clearInterval(l)},i);else c(e)}var u,d,p=0,h=t(".js-sharecount"),f="Facebook: <%=facebook%> \nTwitter: <%=twitter%>",g={facebook:"n/a",twitter:"n/a"};return function(){if(h.length){var t="http://www.theguardian.com/"+i.page.pageId;try{o({url:"https://graph.facebook.com/"+t,type:"json",method:"get",crossOrigin:!0}).then(function(e){var t=e.shares||0;g.facebook=t,l(t),m()}),o({url:"https://cdn.api.twitter.com/1/urls/count.json?url="+t,type:"jsonp",method:"get",crossOrigin:!0}).then(function(e){var t=e.count||0;g.twitter=t,l(t),m()})}catch(n){e.captureException(new Error("Error retrieving share counts ("+n.message+")"),{tags:{feature:"share-count"}})}}}}),define("bootstraps/trail",["enhancer","fastdom","qwery","common/utils/_","common/utils/$","common/utils/config","common/utils/contains","common/utils/mediator","common/utils/robusts","common/utils/proximity-loader","common/modules/commercial/comment-adverts","common/modules/discussion/loader","common/modules/identity/api","common/modules/onward/onward-content","common/modules/onward/popular","common/modules/onward/related","common/modules/onward/tonal","common/modules/social/share-count"],function(e,t,o,n,i,s,r,a,c,m,l,u,d,p,h,f,g,v){function b(e,t){if(window.location.hash)t();else{var n=o(e)[0];n&&m.add(n,1500,t)}}function y(){s.page.isFront||b(".js-popular-trails",function(){(new h).init()})}function w(){b(".js-related",function(){var e={excludeTags:[]};"advertisement-features"!==s.page.sponsorshipType&&e.excludeTags.push("tone/advertisement-features"),"contentType"in s.page&&r(["video","interactive"],s.page.contentType.toLowerCase())&&e.excludeTags.push("guardian-professional/guardian-professional"),new f(e).renderRelatedComponent()})}function C(){b(".js-onward",function(){(s.page.seriesId||s.page.blogIds)&&s.page.showRelatedContent?new p(o(".js-onward")):""!==s.page.tones&&i(".js-onward").each(function(e){(new g).fetch(e,"html")})})}function k(){if(s.switches.discussion&&s.page.commentable){var e=o(".discussion")[0];e&&(new u).attachTo(e)}}function T(){/Article|Interactive|LiveBlog/.test(s.page.contentType)&&i("figure.interactive").each(function(o){t.defer(function(){e.render(o,document,s,a)})})}function _(){d.isUserLoggedIn()||t.write(function(){i(".js-comments").appendTo(o(".js-repositioned-comments"))})}return function(){c([["c-discussion",k],["c-comments",_],["c-enhance",T],["c-shares",v],["c-popular",y],["c-related",w],["c-onward",C],["c-comment-adverts",l]])}}),define("bootstraps/article",["qwery","bean","common/utils/$","common/utils/config","common/utils/detect","common/utils/mediator","common/utils/url","common/modules/article/rich-links","common/modules/article/membership-events","common/modules/article/open-module","common/modules/article/truncation","common/modules/experiments/ab","common/modules/onward/geo-most-popular","common/modules/onward/social-most-popular","bootstraps/article-liveblog-common","bootstraps/trail"],function(e,t,o,n,i,s,r,a,c,m,l,u,d,p,h,f){var g={initCmpParam:function(){var e=r.getUrlVars();e.CMP&&o(".element-pass-cmp").each(function(t){t.src=t.src+"?CMP="+e.CMP})},initRightHandComponent:function(){var t=e(".js-content-main-column");t[0]&&t[0].offsetHeight>1150&&i.isBreakpoint({min:"desktop"})&&d.render()},initSocialMostPopular:function(){var t=e(".js-social-most-popular");t&&(u.shouldRunTest("ArticleTruncation","variant")?new p(t,i.socialContext()):["Twitter","Facebook"].forEach(function(e){u.shouldRunTest(e+"MostViewed","variant")&&new p(t,e.toLowerCase())}))},initPintrest:function(){u.shouldRunTest("Pintrest","variant")&&o(".social__item--pinterest").each(function(e){o(e).css("display","block"),t.on(e,"click",function(e){e.preventDefault(),require(["js!https://assets.pinterest.com/js/pinmarklet.js?r="+(new Date).getTime()])})})},initQuizListeners:function(){require(["ophan/ng"],function(e){s.on("quiz/ophan-event",e.record)})},initTruncation:function(){u.shouldRunTest("ArticleTruncation","variant")&&l()}},v=function(){f(),h(),g.initRightHandComponent(),g.initCmpParam(),g.initSocialMostPopular(),g.initQuizListeners(),g.initPintrest(),g.initTruncation(),a.upgradeRichLinks(),a.insertTagRichLink(),c.upgradeEvents(),m.init(),s.emit("page:article:ready")};return{init:v,modules:g}});
//# sourceMappingURL=article.js.map